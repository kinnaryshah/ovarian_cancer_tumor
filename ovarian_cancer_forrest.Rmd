---
title: "ds_proj"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r spe}

#DOWNLOADING

library(SpatialExperiment)
library(ggspavis)
library(scater)


(spe <- read10xVisium("/users/kshah/ovarian_cancer_forrest/outs/",
  type = "sparse",   # use sparse (not HDF5) format
  data = "filtered",      # read all (not filtered) data
  images = "lowres", # specify which image(s) to include
  load = TRUE))      # specify whether or not to load image(s)

assayNames(spe)

head(rowData(spe)) #only has symbol column (analogous to gene_name), does not have feature_type
head(colData(spe)) #does not have cell count column because cell segmentation was not done

head(spatialCoords(spe))

```

```{r qc}

#QUALITY CONTROL

plotSpots(spe)

is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$symbol)
table(is_mito)
rowData(spe)$symbol[is_mito]
spe <- addPerCellQC(spe, subsets = list(mito = is_mito))
head(colData(spe))
hist(colData(spe)$subsets_mito_percent, breaks = 20)
qc_mito <- colData(spe)$subsets_mito_percent > 28 #none
table(qc_mito)

hist(colData(spe)$sum, breaks = 20)

qc_lib_size <- colData(spe)$sum < 600
table(qc_lib_size)
colData(spe)$qc_lib_size <- qc_lib_size
plotQC(spe, type = "spots", 
       discard = "qc_lib_size")

hist(colData(spe)$detected, breaks = 20)
qc_detected <- colData(spe)$detected < 400
table(qc_detected)
colData(spe)$qc_detected <- qc_detected
plotQC(spe, type = "spots", 
       discard = "qc_detected")

apply(cbind(qc_lib_size, qc_detected, qc_mito), 2, sum)

discard <- qc_lib_size | qc_detected | qc_mito
table(discard)

plotQC(spe, type = "spots", 
       discard = "discard")

#spe <- spe[, !colData(spe)$discard] this does not work for some reason, but the genes are the same for lib size and detected, so i just removed them

spe <- spe[, !colData(spe)$qc_lib_size]
dim(spe)

```

```{r norm}

#NORMALIZATION

library(scran)

# calculate library size factors
spe <- computeLibraryFactors(spe)
summary(sizeFactors(spe))
hist(sizeFactors(spe), breaks = 20)

# calculate logcounts and store in object
spe <- logNormCounts(spe)

# check
assayNames(spe)
dim(logcounts(spe))
```


```{r hvgs}

#FEATURE SELECTION

# fit mean-variance relationship
dec <- modelGeneVar(spe)

# remove 13 mitochondrial genes
spe <- spe[!is_mito, ]
dim(spe)

# visualize mean-variance relationship
fit <- metadata(dec)
plot(fit$mean, fit$var, 
     xlab = "mean of log-expression", ylab = "variance of log-expression")
curve(fit$trend(x), col = "dodgerblue", add = TRUE, lwd = 2)

# select top HVGs
top_hvgs <- getTopHVGs(dec, prop = 0.1)
length(top_hvgs) #1300 
```


```{r pca}

#DIMENSIONALITY REDUCTION

# compute PCA
set.seed(123)
top_hvgs_indices <- which(rownames(rowData(spe)) %in% top_hvgs)

spe <- runPCA(spe, subset_row = top_hvgs_indices)

reducedDimNames(spe)
dim(reducedDim(spe, "PCA"))

```

```{r clust}

#CLUSTERING

# graph-based clustering
set.seed(123)
k <- 10
g <- buildSNNGraph(spe, k = k, use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
clus <- g_walk$membership
table(clus)

# store cluster labels in column 'label' in colData
colLabels(spe) <- factor(clus)

# plot clusters in spatial x-y coordinates
plotSpots(spe, annotate = "label", 
          palette = "libd_layer_colors")

# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = "libd_layer_colors")

```



